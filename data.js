// Firebase'den gelecek veriler
let noteGroups = [];
let events = [];

// Global variables
let currentUser = null;
let currentDate = new Date();
let selectedDate = null;
let selectedNote = null;

const monthNames = [
    'Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran',
    'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'
];

// Utility functions
function generateId() {
    return Date.now() + Math.random();
}

function formatDate(date) {
    return new Date(date).toLocaleDateString('tr-TR', { 
        day: 'numeric', 
        month: 'short' 
    });
}

function getCurrentDate() {
    return new Date().toISOString().split('T')[0];
}

// Ana Firebase veri y√ºkleme fonksiyonu
function loadUserNotes() {
    if (!currentUser) return;
    
    if (currentUser.uid === 'demo-user') {
        loadDemoData();
        return;
    }
    
    try {
        // √ñnce notlarƒ± y√ºkle
        firebase.firestore().collection('notes')
          .where('userId', '==', currentUser.uid)
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            const personalGroup = {
                id: 'personal',
                title: 'üìå Ki≈üisel',
                notes: []
            };
            
            snapshot.forEach((doc) => {
                const noteData = doc.data();
                personalGroup.notes.push({
                    id: doc.id,
                    title: noteData.title,
                    content: noteData.content,
                    preview: noteData.content.substring(0, 80) + (noteData.content.length > 80 ? '...' : ''),
                    tags: noteData.tags || ['yeni'],
                    date: formatDate(noteData.createdAt?.toDate() || new Date()),
                    created_at: noteData.createdAt?.toDate().toISOString().split('T')[0] || getCurrentDate()
                });
            });
            
            // Ki≈üisel grubu ba≈üta yerle≈ütir
            noteGroups = [personalGroup];
            
            // Gruplarƒ± ayrƒ± olarak y√ºkle
            loadUserGroups();
            
            // Sidebar'ƒ± render et
            if (typeof renderSidebar === 'function') {
                renderSidebar();
            }
        });
        
        // Etkinlikleri y√ºkle
        loadUserEvents();
        
    } catch (error) {
        console.error('Error loading notes:', error);
        loadDemoData();
    }
}

// Firebase'den gruplarƒ± y√ºkle
function loadUserGroups() {
    if (!currentUser || currentUser.uid === 'demo-user') return;
    
    try {
        firebase.firestore().collection('groups')
          .where('userId', '==', currentUser.uid)
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            // Ki≈üisel grubu koru, diƒüerlerini ekle
            const personalGroup = noteGroups.find(g => g.id === 'personal');
            noteGroups = personalGroup ? [personalGroup] : [];
            
            snapshot.forEach((doc) => {
                const groupData = doc.data();
                noteGroups.push({
                    id: doc.id,
                    title: `${groupData.icon || 'üìÅ'} ${groupData.title}`,
                    notes: []
                });
            });
            
            // Sidebar'ƒ± g√ºncelle
            if (typeof renderSidebar === 'function') {
                renderSidebar();
            }
        });
        
    } catch (error) {
        console.error('Error loading groups:', error);
    }
}

// Firebase'den etkinlikleri y√ºkle
function loadUserEvents() {
    if (!currentUser || currentUser.uid === 'demo-user') return;
    
    try {
        firebase.firestore().collection('events')
          .where('userId', '==', currentUser.uid)
          .onSnapshot((snapshot) => {
            events = [];
            
            snapshot.forEach((doc) => {
                const eventData = doc.data();
                events.push({
                    id: doc.id,
                    title: eventData.title,
                    description: eventData.description,
                    date: eventData.date,
                    time: eventData.time
                });
            });
            
            // Takvimi g√ºncelle
            if (typeof renderCalendar === 'function') {
                renderCalendar();
            }
        });
        
    } catch (error) {
        console.error('Error loading events:', error);
    }
}

// Firebase'e not kaydetme
async function saveNoteToFirebase(note) {
    if (!currentUser || currentUser.uid === 'demo-user') return;
    
    try {
        await firebase.firestore().collection('notes').doc(note.id).set({
            title: note.title,
            content: note.content,
            tags: note.tags,
            userId: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Note saved to Firebase:', note.id);
    } catch (error) {
        console.error('Error saving note:', error);
    }
}

// Firebase'e grup kaydetme
async function saveGroupToFirebase(group) {
    if (!currentUser || currentUser.uid === 'demo-user') return;
    
    try {
        await firebase.firestore().collection('groups').doc(group.id).set({
            title: group.title.replace(/^[üìÅüìÇüìäüíºüéØüìöüî•‚≠êüí°üöÄ]\s/, ''), // Icon'u √ßƒ±kar
            icon: group.title.match(/^[üìÅüìÇüìäüíºüéØüìöüî•‚≠êüí°üöÄ]/)?.[0] || 'üìÅ',
            userId: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            noteCount: group.notes ? group.notes.length : 0
        });
        
        console.log('‚úÖ Group saved to Firebase:', group.id);
    } catch (error) {
        console.error('Error saving group:', error);
    }
}

// Firebase'e etkinlik kaydetme
async function saveEventToFirebase(event) {
    if (!currentUser || currentUser.uid === 'demo-user') return;
    
    try {
        await firebase.firestore().collection('events').doc(event.id).set({
            title: event.title,
            description: event.description,
            date: event.date,
            time: event.time,
            userId: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Event saved to Firebase:', event.id);
    } catch (error) {
        console.error('Error saving event:', error);
    }
}

// Demo data function - Firebase baƒülantƒ±sƒ± yoksa
function loadDemoData() {
    noteGroups = [
        {
            id: 'personal',
            title: 'üìå Ki≈üisel',
            notes: [
                {
                    id: 1,
                    title: 'üéØ Bug√ºnk√º Hedefler',
                    content: 'Bug√ºn yapƒ±lacaklar:\n‚Ä¢ Proje sunumunu hazƒ±rla\n‚Ä¢ E-postalarƒ± kontrol et\n‚Ä¢ Spor salonuna git\n‚Ä¢ Market alƒ±≈üveri≈üi',
                    preview: 'Bug√ºn yapƒ±lacaklar: ‚Ä¢ Proje sunumunu hazƒ±rla ‚Ä¢ E-postalarƒ± kontrol et...',
                    tags: ['g√ºnl√ºk', 'hedef'],
                    date: formatDate(new Date()),
                    created_at: getCurrentDate()
                },
                {
                    id: 2,
                    title: 'üí° Proje Fikirleri',
                    content: 'Yeni proje i√ßin fikirler:\n‚Ä¢ AI destekli not alma uygulamasƒ±\n‚Ä¢ Akƒ±llƒ± takvim entegrasyonu\n‚Ä¢ Chatbot √∂zelliƒüi',
                    preview: 'Yeni proje i√ßin fikirler: ‚Ä¢ AI destekli not alma uygulamasƒ±...',
                    tags: ['proje', 'ai'],
                    date: formatDate(new Date() - 24*60*60*1000),
                    created_at: getCurrentDate()
                }
            ]
        },
        {
            id: 'work',
            title: 'üíº ƒ∞≈ü',
            notes: [
                {
                    id: 3,
                    title: 'üìä Haftalƒ±k Rapor',
                    content: 'Bu hafta tamamlanan i≈üler:\n‚Ä¢ M√º≈üteri toplantƒ±sƒ±\n‚Ä¢ Kod review\n‚Ä¢ Dok√ºmantasyon g√ºncellemesi',
                    preview: 'Bu hafta tamamlanan i≈üler: ‚Ä¢ M√º≈üteri toplantƒ±sƒ± ‚Ä¢ Kod review...',
                    tags: ['rapor', 'haftalƒ±k'],
                    date: formatDate(new Date() - 2*24*60*60*1000),
                    created_at: getCurrentDate()
                }
            ]
        }
    ];
    
    // Demo events
    events = [
        {
            id: 1,
            title: 'Toplantƒ±',
            description: 'Proje toplantƒ±sƒ±',
            date: getCurrentDate(),
            time: '14:00'
        },
        {
            id: 2,
            title: 'Doktor',
            description: 'Doktor randevusu',
            date: new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0],
            time: '10:30'
        }
    ];
    
    console.log('üìö Demo data y√ºklendi');
    
    if (typeof renderSidebar === 'function') {
        renderSidebar();
    }
    
    if (typeof renderCalendar === 'function') {
        renderCalendar();
    }
}

// Belge y√ºkleme fonksiyonu
function uploadDocument(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                
                // Yeni not olu≈ütur
                const newNote = {
                    id: generateId().toString(),
                    title: `üìÑ ${file.name}`,
                    content: content.substring(0, 5000) + (content.length > 5000 ? '...' : ''),
                    preview: `Dosyadan y√ºklendi: ${file.name}`,
                    tags: ['dosya', 'y√ºklendi', file.type.includes('pdf') ? 'pdf' : 'belge'],
                    date: formatDate(new Date()),
                    created_at: getCurrentDate()
                };
                
                // ƒ∞lk gruba ekle (Ki≈üisel)
                if (noteGroups.length === 0) {
                    noteGroups.push({
                        id: 'personal',
                        title: 'üìå Ki≈üisel',
                        notes: []
                    });
                }
                
                noteGroups[0].notes.unshift(newNote);
                
                // Firebase'e kaydet
                if (currentUser && currentUser.uid !== 'demo-user') {
                    saveNoteToFirebase(newNote);
                }
                
                resolve(newNote);
            } catch (error) {
                reject(error);
            }
        };
        
        reader.onerror = function() {
            reject(new Error('Dosya okuma hatasƒ±'));
        };
        
        // Dosya tipine g√∂re okuma
        if (file.type.includes('text') || file.name.endsWith('.txt')) {
            reader.readAsText(file, 'UTF-8');
        } else if (file.type.includes('pdf')) {
            // PDF i√ßin base64 okuma (basit metin √ßƒ±karma i√ßin)
            reader.readAsText(file, 'UTF-8');
        } else {
            reader.readAsText(file, 'UTF-8');
        }
    });
}

// Kullanƒ±cƒ± verilerini temizleme
function clearUserData() {
    noteGroups = [];
    events = [];
    selectedNote = null;
    selectedDate = null;
    
    // UI'yi temizle
    const notesContainer = document.getElementById('notesContainer');
    if (notesContainer) {
        notesContainer.innerHTML = '';
    }
    
    const welcomeScreen = document.getElementById('welcomeScreen');
    if (welcomeScreen) {
        welcomeScreen.style.display = 'flex';
    }
    
    const editor = document.getElementById('noteEditor');
    if (editor) {
        editor.style.display = 'none';
    }
}

// Export functions for global use
window.loadUserNotes = loadUserNotes;
window.saveNoteToFirebase = saveNoteToFirebase;
window.saveGroupToFirebase = saveGroupToFirebase;
window.saveEventToFirebase = saveEventToFirebase;
window.uploadDocument = uploadDocument;
window.clearUserData = clearUserData;